---
title: Redis 持久化
date: 2020-04-15 11:03:27
categories:
  - Redis
tags:
  - Redis
---

## 前言

相比 Memcache 而言，Redis 可以把数据持久化到我们的磁盘上。来保证缓存的数据不会应为断电而丢失。



## 简介

数据存放于：

- 内存：高效、断电（关机）内存数据会丢失
- 硬盘：读写速度慢于内存，断电数据不会丢失

> Redis 持久化存储支持两种方式：RDB 和 AOF。
>
> - RDB 一定时间存储文件
> - AOF 默认每秒存储历史命令
>
> Redis 支持持久化的内存数据库，也就是Redis需要经营将内存中的数据同步到硬盘来保证持久化。

<!-- more -->

## RDB

RDB 是 redis database 缩写。是Redis的默认持久化机制。

功能核心函数 dbSave （生成RDB文件）和 rdbLoad（从文件加载内存）两个函数。

快照是默认持久化方式。这种方式就是将内存中数据以快照的方式写入到二进制文件中，默认的文件名为 dump.rdb



优点：

- 快照保存数据极快、还原数据快
- 适用于灾难备份

缺点：

- 小内存机器不适合使用，RDB机制符合要求就会照快照



快照条件：

```
1. 服务器正常关闭时  redis-cli shutdown
2. key满足一定条件，会进行快照
redis.conf
save 900 1    # 每900秒（15分钟）至少1个key发生变化，产生快照
save 300 10   # 每300秒（5分钟）至少10个key发生变化，产生快照
save 60 10000 # 每60秒（1分钟）至少10000个key发生变化，产生快照
```



## AOF

由于快照方式实在一定间隔时间做一次，所以如果redis意外down掉的话，就会丢失最后一次快照后的所有修改。如果应用要求不能丢失任何修改的话，可以采用aof持久化方式。

Append-only file：aof比快照方式有更好的持久化性，是由于在使用aof持久化方式时，redis会将每一个收到的写命令都通过write函数追加到文件中（默认是appendonly.aof）。当redis重启时会通过重新执行文件中保存的写命令来在内存中重建整个数据库的内容。

每当执行服务器（定时）任务或者函数时flushAppendOnlyFile函数都会被调用，这个函数执行以下两个工作aof写入保存：

- WRITE：根据条件，将aof_buf中的缓存写入到AOF文件中
- SAVE：根据条件，调用fsync或fdatasync函数，将AOF文件保存到磁盘中



有三种方式如下（默认是：每秒fsync一次）

- appendonly yes  启用aof持久化模式
- `appendfsync <parameter>`
  - always 收到写命令就立刻写入磁盘，最慢，但保证完全的持久化
  - everysec 每秒钟写入磁盘一次，在性能和持久化方面做了很好的折中
  - no 完全依赖os，性能最好，持久化没保证



### 产生的问题：

aof的方式也同时带来了另一个问题。持久化文件会变得越来越大。例如我们调用incr test命令100次，文件中必须保存全部的100条命令，其实有99条都是多余的。



## 总结

开启配置之后，我们已经拥有了比较健全的持久化方案了。具体的调整还是要看具体的业务需求了。